#!/usr/bin/env bash

root=`pwd`

watchman watch-del "$root"
watchman watch-project "$root"
watchman trigger-del "$root" rails
watchman -j <<-JSON
[
  "trigger",
  "$root",
  {
    "name": "rails",
    "expression": [
      "anyof",
      ["match", "config/**/*.rb", "wholename"],
      ["match", "lib/**/*.rb", "wholename"],
      ["name", ["Gemfile", "Gemfile.lock", "config.ru"]],
      [
        "allof",
        ["dirname", "app", ["depth", "eq", 0]],
        ["type", "d"]
      ]
    ],
    "command": ["bin/rails", "restart"]
  }
]
JSON

while true; do
  sleep 1
done
